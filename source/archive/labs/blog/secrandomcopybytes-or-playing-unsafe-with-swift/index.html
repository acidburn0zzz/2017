<doctype html>
<html lang='en'>
<head>
	<meta charset='utf-8'>
	<meta name='viewport' content='width=device-width,initial-scale=1' />
	<title>Ind.ie Labs - Blog - Node 0.12.0 and native add-on modules</title>
	<!--[if lte IE 8]>
        <script src='https://ind.ie/assets/js/html5shiv.js'></script>
    <![endif]-->
    <link rel='shortcut icon' href='/favicon.ico'>
    <link rel='apple-touch-icon' href='https://ind.ie/assets/images/ios-180.png'>
    <link rel='apple-touch-icon' sizes='76x76' href='https://ind.ie/assets/images/ios-76.png'>
    <link rel='apple-touch-icon' sizes='120x120' href='https://ind.ie/assets/images/ios-120.png'>
    <link rel='apple-touch-icon' sizes='152x152' href='https://ind.ie/assets/images/ios-152.png'>
    <link rel='apple-touch-icon' sizes='152x152' href='https://ind.ie/assets/images/ios-180.png'>
	<link rel='alternate' type='application/rss+xml' title='Ind.ie Labs Blog' href='https://ind.ie/labs/blog/rss/index.xml' />
	<link rel='stylesheet' href='/assets/css/lab-styles.css'/>
	<link rel="stylesheet" href="../css/highlight/kimbie.dark.css">
	<link rel='stylesheet' href='../css/styles.css'/>
	<script src="../js/highlight.pack.js"></script>
	<script>hljs.initHighlightingOnLoad();</script></head>
<body class='labs labs-blog'>
	<!-- @import '../../../../assets/includes/_nav.kit' -->
	<div class='main h-entry'>
        <!-- @import '../../../../includes/_archive-notice.kit' -->
<h1 class='p-name long-title'>SecRandomCopyBytes, or: Playing Unsafe with Swift</h1>
		<p class='post-date dt-published' datetime='2015-03-21 15:04:00'>21st March, 2015 — <span class='p-author'>Stefan van den Oord</span></p>
		<div class='e-content'>
		
<p>The Apple Security Framework has this function <code>SecRandomCopyBytes()</code> that allows you to create <a href="https://developer.apple.com/library/ios/documentation/Security/Reference/RandomizationReference/index.html#//apple_ref/c/func/SecRandomCopyBytes">an array of cryptographically secure random bytes</a>. There are many ways to generate random data on iOS and OS X, but I wanted to use this one because it is suitable for cryptographic purposes. Of course I could have used <a href="http://nshipster.com/random/"><code>arc4random()</code></a>, but then this blog post would not have been nearly as interesting. So <a href="https://mikeash.com/pyblog/friday-qa-2011-03-18-random-numbers.html"><code>SecRandomCopyBytes()</code></a> it is. Now, <a href="https://source.ind.ie/project/pulse-swift/tree/master">this project that I'm working on</a> happens to be written in <a href="https://developer.apple.com/swift/">Swift</a>. And I didn't have a clue how to call it from Swift. So let's start the easy way.</p>

<h2>Round 1: Objective-C</h2>

<p>What I do know, is how to call it from Objective-C.</p>

<pre>Objective-C:<code class="objective-c">int32_t randomNumber = 0;
SecRandomCopyBytes(kSecRandomDefault, 4, (uint8_t*) &amp;randomNumber);
</code></pre>

<p>That wasn't so hard. First, we declare a 32-bit integer (and initialize it to zero). Then we call <code>SecRandomCopyBytes</code> passing 4 as count (4 bytes are 32 bits), as well as the memory location where the random bytes should be stored: the address of the random number integer that we just declared. Success, we won round 1.</p>

<h2>Round 2: First Swift Attempt</h2>

<p>I guess I could wrap it up here, after all it's no problem at all to <a href="https://developer.apple.com/library/prerelease/ios/documentation/Swift/Conceptual/BuildingCocoaApps/index.html">call Objective-C from Swift</a>. But that's cheating, what would I have learned? So let's try this in Swift.</p>

<pre>Swift:<code class="swift">var randomNumber : Int32  = 0
SecRandomCopyBytes(kSecRandomDefault, 4, &amp;randomNumber)
</code></pre>

<p>Unfortunately, this results in a compiler error: <code>'Int32' is not identical to 'UInt8'</code>. The beauty of strongly typed languages! We lost this round.</p>

<h2>Round 3: Playing Unsafe</h2>

<p>So if this is a strongly typed language, what type is it that we need then? Looking at <a href="https://developer.apple.com/library/ios/documentation/Security/Reference/RandomizationReference/index.html#//apple_ref/c/func/SecRandomCopyBytes">the documentation</a> tells us that we need a variable of type <code>UnsafeMutablePointer&lt;UInt8&gt;</code>. So how do we take an <code>Int32</code> and use it as an <code>UnsafeMutablePointer&lt;UInt8&gt;</code>? In fact, there's two steps to this: (1) obtain an <code>UnsafeMutablePointer</code>, and (2) cast it from a pointer to <code>UInt32</code> to a pointer to <code>UInt8</code>.</p>

<h3>withUnsafeMutablePointer</h3>

<p>It turns out that we need to use <code>withUnsafeMutablePointer</code> for the first step. When trying to find out how this works, the Swift iBooks are of no use; it is not documented there. So let's look at the definition in Xcode. We read:</p>

<pre>Swift:<code class="swift">/// Invokes `body` with an `UnsafeMutablePointer` to `arg` and returns the
/// result. Useful for calling Objective-C APIs that take "in/out"
/// parameters (and default-constructible "out" parameters) by pointer
func withUnsafeMutablePointer&lt;T, Result&gt;(inout arg: T, body: (UnsafeMutablePointer&lt;T&gt;) -&gt; Result) -&gt; Result
</code></pre>

<p>Let's analyze this. <code>withUnsafeMutablePointer</code> is a template method that uses two template types: <code>T</code> and <code>Result</code>. It has two arguments: the first one is an in-out parameter called <code>arg</code>, which has type <code>T</code>. The second one is a closure called <code>body</code>. This closure takes one argument, of type <code>UnsafeMutablePointer&lt;T&gt;</code>, and has return type <code>Result</code>. Finally, the return type of <code>withUnsafeMutablePointer</code> itself is also <code>Result</code>.</p>

<p>Right. But what does it <em>do</em>? After reading it a couple of times, you'll find that the documentation actually says it accurately (though tersely): it takes a reference to a Swift variable, and makes it available as an <code>UnsafeMutablePointer</code> inside the closure. So now we can type something like this:</p>

<pre>Swift:<code class="swift">var randomNumber : Int32  = 0
withUnsafeMutablePointer(&amp;randomNumber, { (randomNumberPointer) -&gt; Void in
    var proof : UnsafeMutablePointer&lt;Int32&gt; = randomNumberPointer
})
</code></pre>

<p>This compiles, just to prove to you that the <code>randomNumberPointer</code> is indeed an <code>UnsafeMutablePointer&lt;Int32&gt;</code>.</p>

<h3>unsafeBitCast</h3>

<p>So now we get to the second step: we don't need a pointer to <code>Int32</code>, we need a pointer to <code>UInt8</code> in order to call <code>SecRandomCopyBytes</code>. Enter <code>unsafeBitCast</code>.</p>

<p>As an Objective-C programmer, you probably know that the pointer is just the address of a memory location and you don't really care about the type of the pointer, as long as the size of the memory location is correct. So in Objective-C you can just use type casting:</p>

<pre>Swift:<code class="swift"> int32_t number = 0;
 uint8_t *numberPointer = (uint8_t*) &amp;number;
</code></pre>

<p>In fact, if you leave out the type cast, the compiler will only generate a warning and let you run the program anyway. The type cast is there so that we can tell the compiler that we know better than it does, it doesn't need to worry, <a href="http://www.menlo.com/folks/adamm/lang-shoot.html">we know what we're doing</a>.</p>

<p>The function <code>unsafeBitCast</code> is the Swift equivalent of the type cast. Let's look at the definition:</p>

<pre>Swift:<code class="swift">/// Returns the the bits of `x`, interpreted as having type `U`.
///
/// .. Caution:: Breaks the guarantees of Swift's type system; use
///    with extreme care.  There's almost always a better way to do
///    anything.
///
func unsafeBitCast&lt;T, U&gt;(x: T, _: U.Type) -&gt; U
</code></pre>

<p>So it takes a parameter <code>x</code> of type <code>T</code> and an anonymous parameter that is itself a type, and returns the parameter <code>x</code> casted to that type. Let's apply this to our code. We don't need to return a value from <code>withUnsafeMutablePointer</code>, so as a result type I choose <code>Void</code>. Please note the construct <code>UnsafeMutablePointer&lt;UInt8&gt;.self</code> to specify the type to which we want the pointer to be casted.</p>

<pre>Swift:<code class="swift">var randomNumber : Int32  = 0
withUnsafeMutablePointer(&amp;randomNumber, { (randomNumberPointer) -&gt; Void in
    var castedPointer = unsafeBitCast(randomNumberPointer, UnsafeMutablePointer&lt;UInt8&gt;.self)
    SecRandomCopyBytes(kSecRandomDefault, 4, castedPointer)
})
</code></pre>

<p>That's it. Now <code>randomNumber</code> contains 32 bits of random data. Hurrah!</p>

<h2>Wrapping it up</h2>

<p>I hope you learned something here, I know I did! I enjoy coding in Swift, and I am happy that Apple has the <a href="http://www.extremeprogramming.org/values.html">courage</a> to <a href="http://leankit.com/kanban/continuous-improvement/">keep improving it</a>. When you get to the boundaries between Swift and (Objective-)C, it can be a struggle sometimes however.</p>

<p>On a final note: After reading the <em>caution</em> about <code>unsafeBitCast</code> ("There's almost always a better way to do anything") I do have this nagging question whether there is a better way in this case, and what it would be, but that's maybe for another time. Suggestions and <a href="http://www.extremeprogramming.org/values.html">feedback</a> are highly appreciated! Please visit <a href='https://medium.com/@stefanvdoord/secrandomcopybytes-or-playing-unsafe-with-swift-e627397e1b11'>the copy of my article on Medium</a> to leave comments.</p>
		</div>
		<div id="discourse-comments"></div>

		<footer class="site-footer">
                <h2 class="site-name"><a href="https://ind.ie">ind.ie</a></h2>
                <small class="copyright"><abbr title="Copyright">©</abbr> <a href="/about/#trademarks">Article 12</a>. All content is <a href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International</a>, unless otherwise stated.</small>
                <div class="view-source-wrap">
                    <a class="view-source" href="https://source.ind.ie/project/ind-ie-site/tree/master">View source</a>
                </div>
            </footer>
	</div>
    <script type='text/javascript'>
      var discourseUrl = 'https://forum.ind.ie/',
          discourseEmbedUrl = 'https://ind.ie/labs/blog/secrandomcopybytes-or-playing-unsafe-with-swift/';

      (function() {
        var d = document.createElement('script'); d.type = 'text/javascript'; d.async = true;
          d.src = discourseUrl + 'javascripts/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(d);
            })();
    </script>
</body>
</html>